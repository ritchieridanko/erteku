# ---------- Build Stage ----------
FROM golang:1.24.2-alpine3.20 AS builder

# Install build dependencies
RUN apk add --no-cache git

# Set work directory
WORKDIR /app/services/auth

# Copy and download app dependencies
COPY shared ../../shared
COPY services/auth/go.mod services/auth/go.sum ./
RUN go mod download

# Copy app source
COPY services/auth/cmd/migrator ./cmd/migrator
COPY services/auth/configs ./configs
COPY services/auth/internal/constants ./internal/constants
COPY services/auth/internal/infra/database ./internal/infra/database
COPY services/auth/internal/infra/logger ./internal/infra/logger
COPY services/auth/internal/utils ./internal/utils
COPY services/auth/migrations ./migrations

# Build app
RUN CGO_ENABLED=0 go build -ldflags="-s -w" -o bin/migrator cmd/migrator/main.go

# ---------- Runtime Stage ----------
FROM alpine:3.20

# Set work directory
WORKDIR /root

# Copy from the Build Stage
COPY --from=builder /app/services/auth/bin ./bin
COPY --from=builder /app/services/auth/configs ./configs
COPY --from=builder /app/services/auth/migrations ./migrations

# Set entry point
ENTRYPOINT ["./bin/migrator"]
